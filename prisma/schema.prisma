// Kadaver Poetry Society - Database Schema
// A sanctuary for poetry in three tongues

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Language {
  de // German
  en // English
  ru // Russian
}

enum UserRole {
  READER     // Can read and like works
  POET       // Can submit works
  EDITOR     // Can approve submissions
  ADMIN      // Full access
}

enum WorkType {
  POEM
  TALE
  NOVEL
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  displayName   String?
  avatarUrl     String?
  bio           String?   @db.Text
  role          UserRole  @default(READER)

  // Supabase Auth ID for integration
  supabaseId    String?   @unique

  // Relations
  submissions   Submission[]
  favorites     Favorite[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([email])
  @@index([supabaseId])
}

// ============================================
// AUTHOR (Formerly Poet)
// ============================================

model Author {
  id            String    @id @default(cuid())
  slug          String    @unique

  // Multilingual name support
  name          String
  nameOriginal  String?   // Name in original script (e.g., Cyrillic)

  // Biographical info
  bio           String?   @db.Text
  bioRu         String?   @db.Text
  bioDe         String?   @db.Text
  bioEn         String?   @db.Text

  portraitUrl   String?
  birthYear     Int?
  deathYear     Int?
  nationality   String?

  // Languages the author writes in
  languages     Language[]

  // External links
  wikipediaUrl  String?
  websiteUrl    String?

  // Relations
  works         Work[]

  // Metadata
  featured      Boolean   @default(false)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([slug])
  @@index([featured])
}

// ============================================
// TAG (Categories for works)
// ============================================

model Tag {
  id            String    @id @default(cuid())
  slug          String    @unique

  // Multilingual names
  nameEn        String
  nameDe        String
  nameRu        String

  // Tag metadata
  description   String?   @db.Text
  color         String?   // Hex color for UI

  // Relations
  works         WorkTag[]

  createdAt     DateTime  @default(now())

  @@index([slug])
}

// ============================================
// WORK (The unified unified creative entity)
// ============================================

model Work {
  id            String    @id @default(cuid())
  slug          String    @unique
  type          WorkType  @default(POEM)

  // Content
  title         String
  content       String?   @db.Text // Nullable for Novels (content is in chapters)
  excerpt       String?   @db.Text

  // Language
  language      Language

  // Author
  authorId      String
  author        Author    @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Audio recording (primarily for Poems)
  audioUrl      String?
  audioDuration Int?      // Duration in seconds
  audioReader   String?   // Who recorded the audio

  // Structure for Novels
  chapters      Chapter[]

  // Visuals & Rendering (The Typesetter)
  // Stores JSON config: { font: "Playfair", align: "center", spacing: "relaxed", dropCap: boolean, etc. }
  renderingConfig Json?

  // Publishing
  published     Boolean   @default(false)
  featured      Boolean   @default(false)
  publishedAt   DateTime?

  // Analytics
  viewCount     Int       @default(0)

  // Source/Attribution
  source        String?   // Book, collection, etc.
  year          Int?      // Year written/published

  // Relations
  tags          WorkTag[]
  favorites     Favorite[]

  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([slug])
  @@index([type])
  @@index([language])
  @@index([authorId])
  @@index([published, featured])
  @@index([publishedAt])
}

// ============================================
// CHAPTER (For Novels)
// ============================================

model Chapter {
  id            String    @id @default(cuid())
  
  workId        String
  work          Work      @relation(fields: [workId], references: [id], onDelete: Cascade)

  order         Int       // Chapter number/order
  title         String?
  content       String    @db.Text
  
  // Specific rendering override for chapter?
  renderingConfig Json?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([workId, order])
}

// ============================================
// WORK-TAG RELATION (Many-to-Many)
// ============================================

model WorkTag {
  workId        String
  tagId         String

  work          Work      @relation(fields: [workId], references: [id], onDelete: Cascade)
  tag           Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)

  assignedAt    DateTime  @default(now())

  @@id([workId, tagId])
  @@index([workId])
  @@index([tagId])
}

// ============================================
// FAVORITE (User's saved works)
// ============================================

model Favorite {
  userId        String
  workId        String

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  work          Work      @relation(fields: [workId], references: [id], onDelete: Cascade)

  createdAt     DateTime  @default(now())

  @@id([userId, workId])
  @@index([userId])
  @@index([workId])
}

// ============================================
// SUBMISSION (User-submitted works)
// ============================================

enum SubmissionStatus {
  PENDING
  APPROVED
  REJECTED
}

model Submission {
  id            String           @id @default(cuid())

  // Submitted content
  title         String
  content       String           @db.Text
  chapters      Json?            // For Novels: [{ title: "Chapter 1", content: "..." }]
  authorName    String           // Can be different from author name
  language      Language
  type          WorkType         @default(POEM)

  // Optional audio
  audioUrl      String?

  // Submitter
  submitterId   String
  submitter     User             @relation(fields: [submitterId], references: [id], onDelete: Cascade)

  // Review status
  status        SubmissionStatus @default(PENDING)
  reviewNotes   String?          @db.Text
  reviewedAt    DateTime?

  // If approved, link to created work
  approvedWorkId String?

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([submitterId])
  @@index([status])
}

// ============================================
// SITE SETTINGS (For admin configuration)
// ============================================

model SiteSettings {
  id            String    @id @default("default")

  // Featured content
  heroQuoteEn   String?   @db.Text
  heroQuoteDe   String?   @db.Text
  heroQuoteRu   String?   @db.Text
  heroAuthor    String?

  // Analytics
  totalViews    Int       @default(0)

  updatedAt     DateTime  @updatedAt
}
